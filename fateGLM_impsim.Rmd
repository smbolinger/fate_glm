---
title: "imputation analysis"
author: "Sarah Bolinger"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
  pdf_document: default
params:
  nrun: 100
  debug: FALSE
  home_dir: "/home/wodehouse/projects/fate_glm/"
  linux: FALSE
  suffix: "100reps"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = "allow")
library(brglm2) # penalized logistic regression
library(CALIBERrfimpute) # could access using ::
library(gt)
library(gtsummary)
library(tidyverse)
source("mice_functions.R")
source("imp_sim_functions.R")
source("missing_data.R")

```


### Remove values from the data to test the efficiency of the imputation with different methods

#### Specify vars, imputation methods, etc:

```{r, warning=FALSE}
# source("GLM_ampute.R")

# suppress_warnings()
# suppressWarnings()
# if(!childd){
#   # I don't remember what I was gonna put in here...
# }
# modList <- readRDS("dataframes/modList.rds")
modList <- readLines("modList.txt")

# ndGLM_scl_cc <- readRDS("dataframes/ndGLM_scl_cc.rds")
# ndGLM_scl_cc <- read.csv("ndGLM_scl_cc.csv")

dat4sim <- read.csv("dat_complete.csv", stringsAsFactors = TRUE)
# made the responses into "yes/no" so I could import them automatically as factors
prVars <- c("species", "cam_fate", "obs_int", "nest_age", "fdate")
resp_list <- c("is_u", "HF_mis")

## FOR TESTING:
if(FALSE){
  # mod4imp <- modList[1]
  var_list <-  c("nest_age", "cam_fateD", "cam_fateA", "cam_fateF", "cam_fateHu", "cam_fateS", "speciesLETE", "speciesLETE:nest_age", "speciesLETE:obs_int")
  bias_names <- c("bias", "pctBias", "covRate", "avgWidth", "RMSE")
  # met_list <- c("pmm", "rf", "cart")
  # met_list <- c("default","pmm", "rf", "cart", "caliber","cc")
  met_list <- c("default", "rf","cc")
  met_list <- c("rf", "caliber")
  nrun <- 2
  debug <- TRUE
  # debug <- FALSE
  # resp is passed from fate_GLM1
}
nrun <- params$nrun
debug <- params$debug
mod4sim <- modList[1]
hdir <- params$home_dir

if(params$linux==FALSE){
  hdir <- "C:/Users/sarah/Dropbox/Models/fate_glm/" 
  nrun <-5 
  suffix <- "5reps"
  debug <- TRUE
}

cat(">> home directory:", hdir, " & number of runs:", nrun, "& output suffix:", suffix)

# var_list <-  c("nest_age", "cam_fateD", "cam_fateA", "cam_fateF", "cam_fateHu", "cam_fateS", "speciesLETE", "speciesLETE:nest_age") # just the vars w/ missing data or interactions
var_list <-  c("nest_age", "cam_fateD", "cam_fateA", "cam_fateF", "cam_fateHu", "cam_fateS", "speciesLETE", "speciesLETE:nest_age", "speciesLETE:obs_int", "obs_int", "fdate") # all vars
bias_names <- c("value","bias", "pctBias", "covRate", "avgWidth", "RMSE", "SD")
# bias_names <- c("bias","pctBias", "covRate", "avgWidth", "RMSE", "SD")
# can't actually use the interaction term in the imputation model bc need identical data for AIC comparison
# won't so this because I also don't know  the specific relationship of the interaction
# , met_list <- c("default","pmm", "rf", "cart", "caliber","default.int","pmm.int","passive.int","cc")
# met_list <- c("default","pmm", "rf", "cart", "caliber","cc","full") # don't need full here?
met_list <- c("default","pmm", "rf", "cart", "caliber","cc")# don't need full here?

# col_sel <- c(prVars,resp) # columns to select, as strings
cat("\n>> methods to test:", met_list)
cat("\n>> bias to be calculated:", bias_names)

```

#### Run the simulation & calculate the bias:

```{r, warning=FALSE}
# Create the simulated data with NAs (using the complete-case df):
# sim_dat <- mkSimDat(nd = ndGLM_scl_cc,col_sel=col_sel, method = "amp", wt = TRUE, debug = TRUE, convFact = TRUE)
sim_dat <- mkSimDat(nd = dat4sim, method = "amp", wt = TRUE, debug = TRUE, convFact = TRUE)
# sim_dat <- mkSimDat(nd = ndGLM_scl_cc, method = "amp", wt = TRUE, debug = debug, convFact = TRUE)
missing_tab("sim_dat",prVars,)
# imp_sim <- runSim(datNA = sim_dat$amp,mets = met_list, resp = resp, vars = var_list, mod = mod, nruns=500)
# imp_sim <- runSim(datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = resp, vars = var_list, mod = mod,seed=61389, nruns=nrun, debug = TRUE)
  # imp_sim <- runSim(datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = r, vars = var_list, mod = mod4sim, nruns=nrun, debug = FALSE) # don't want to set seed
# mods4sim <- modList[c(1,2,8,9,16) ]
# could probably jsut create an index of the models you want and then seq_along the whole list. not sure which is faster
mods4sim <- modList[c(1,8,16) ]
mods4sim
# mods4sim <- modList[c(1,8) ]
names(mods4sim) <- c("m1", "m8", "m16")
# names(mods4sim) <- c("m1", "m8")
# if(FALSE){
#   z <- 3
#   # r <- "is_u"
#   r <- "HF_mis"
# }
# mods4sim
for(z in seq_along(mods4sim)){
  # , cat("\n>>model:", names(model), model)
  cat("\n********************************************************************************************\n")
  cat("\n********************************************************************************************\n")
  cat("\n/////////////////////////////////////////////////////////////////////////////////////////////\n")
  cat("\n********************************************************************************************\n")
  cat("\n>>model:", names(mods4sim)[z], " | ", mods4sim[z])
  cat("\n********************************************************************************************\n")
  cat("\n/////////////////////////////////////////////////////////////////////////////////////////////\n")
  cat("\n********************************************************************************************\n")
  cat("\n********************************************************************************************\n")
  for(r in resp_list){
    col_sel <- c(prVars,r) # columns to select, as strings
    cat("\n\n********************************************************************************************\n")
    cat("\n********************************************************************************************\n")
    cat("\n>> response:", r,"\n\t& columns for imputation:", col_sel)
    cat("\n********************************************************************************************\n")
    cat("\n********************************************************************************************\n")
    # imp_sim <- runSim(datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = resp, vars = var_list, mod = mod4sim, nruns=nrun, debug = FALSE) # don't want to set seed
    # imp_sim <- runSim(dat=ndGLM_scl_cc, datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = r, vars = var_list, mod = mod4sim, nruns=nrun, debug = debug) # don't want to set seed
    # imp_sim <- runSim(datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = r, vars = var_list, mod = mod4sim, nruns=nrun, debug = debug) # don't want to set seed
    imp_sim <- runSim(datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = r, vars = var_list, mod = mods4sim[z], nruns=nrun, debug = debug) # don't want to set seed
    # bias_out <- parAvg(fullDat = ndGLM_scl_cc, impDat = imp_sim,resp = r, vars = var_list, mod = mod4sim,mets = met_list, biasVals = bias_names, debug = debug)
    # bias_out <- parAvg(fullDat = ndGLM_scl_cc, impDat = imp_sim,resp = r, vars = var_list, mod = mods4sim[z], mets = met_list, biasVals = bias_names, debug = debug)
    bias_out <- parAvg(fullDat = dat4sim, impDat = imp_sim,resp = r, vars = var_list, mod = mods4sim[z], mets = met_list, biasVals = bias_names, debug = debug)
    # biasfile <- paste0(params$home_dir, sprintf("out/bias_vals_%s_%s.rds", r, names(mods4sim)[z]))
    biasfile <- paste0(hdir, sprintf("out/bias_vals_%s_%s_%s.rds", r, names(mods4sim)[z], params$suffix))
    # saveRDS(bias_out, sprintf("out/bias_vals_%s_%s.rds",r, names(mods4sim)[z]))
    saveRDS(bias_out, biasfile)
    biasfile1 <- paste0(hdir, sprintf("out/bias_vals_%s_%s_%s.csv", r, names(mods4sim)[z], params$suffix))
    # biasfile1
    # write.csv(bias_out, file = sprintf("out/bias_vals_%s_%s.csv", r, names(mods4sim)[z]))# write to csv in case script aborts 
    # write.csv(bias_out, file = biasfile1, row.names = FALSE)# write to csv in case script aborts 
    ## NOTE - NEED ROW NAMES - that's where the param names are stored |> 
    write.csv(bias_out, file = biasfile1)# write to csv in case script aborts 
    cat("\n\n********************************************************************************************\n")
    cat(">>>>> BIAS VALUES: \n")
    cat("********************************************************************************************\n")
    print(bias_out) # print the output to console
    # cat("\n******************************************************************************************\n")
  }
}
# imp_sim <- runSim(datNA = sim_dat$amp,col_sel = col_sel,mets = met_list, resp = resp, vars = var_list, mod = mod,seed=61389, nruns=nrun)
# saveRDS(imp_sim, "imp_sim_20oct.rds")
```

#### Calculate the bias:

```{r eval=FALSE, warning=FALSE, include=FALSE}
bias_out <- parAvg(fullDat = ndGLM_scl_cc, impDat = imp_sim,resp = resp,vars = var_list, mod = mod4sim,mets = met_list, biasVals = bias_names)
write.csv(bias_out, file = "bias_vals.csv")# write to csv in case script aborts 
bias_out # print the output to console
```


```{r eval=FALSE, warning=FALSE, include=FALSE}
fitReal <- glm(as.formula(paste0(resp, mod4sim)), data=ndGLM_scl_cc, family=fam, method=regMet, control=brglmControl(maxit=iter) )
# 
# trueVals <- coef(fitReal)[var_list]
# test_avg(sim_dat, fitReal)
test_avg(imp_sim, fitReal)
```

#### Test different methods for dealing with the interactions:

```{r}

```
