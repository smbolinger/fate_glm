---
title: "fate_glm_plots"
author: "Sarah Bolinger"
date: "`r Sys.Date()`"
output: html_document
---

### a. Specify the data and variables to use

```{r plot--names-1, echo=TRUE}
# This is mostly for naming files in an informative way.

# datName = "ndGLM1" # specified in main doc; changes depending on where you are in script
# datName = "ndGLM_"
# prVars <- c("species", "cam_fate", "obs_int", "nest_age", "fdate")
dat = get(datName)
# dat <- readRDS("ndGLM_.rds")
# print("data used for plotting/tables:", datName) # print expects digits?
cat("data used for plotting/tables:", datName)

fVar <- "_allFates"
uVar <- "_UHisU"
if(UHisH) uVar <- "_UHisH" 
if(exists("nfate")) fVar <- paste0("_",nfate,"fates") # exists seems to be more complicated than I thought...

# fname <- paste("nest_data/",datName, uVar, now, ".csv", sep="_")
# write.csv(ndGLM1, fname)
# number of fate categories:
# fVar <- paste0("-",nfate,"fates")
```

### Create frequency tables (optional)


```{r freqtabcreate, echo=TRUE}
# frTabInitial <- fr_tab(dat, vars="all")
# frTabInitial2 <- fr_tab(dat, vars="HF_mis")
# frTabInitial3 <- fr_tab(dat, vars="misclass")
# knitr::include_graphics(paste0("analysis/",frTabInitial), 
                        # dpi=(1300/6)) # dpi setting = only thing that works
if(tab1 == TRUE | tab2 == TRUE){
  suff <- paste0("_",datName,uVar, fVar)
  # tabbbb <- fr_tab(ndGLM_cc, vars="HF_mis",suffix = suff)
  tabbbb <- fr_tab(dat, vars="HF_mis",suffix = suff)
  # why does the complete cases dataframe have missing values for HF_mis?
  knitr::include_graphics(paste0("analysis/",tabbbb), 
                          dpi=(1300/6)) # dpi setting = only thing that works
} else {
  cat("\t\t>> skip")
}
```


#### Failure reclassification

```{r}

```

#### more tables

```{r}
"nests with final observation interval > 5:\n"
ndGLM_ <- readRDS("ndGLM_.rds")
ndGLM_ %>% filter(obs_int>5) %>% group_by(cam_fate) %>% summarize(sum=n())
ndGLM_ %>% filter(obs_int>5 & species=="CONI") %>% group_by(cam_fate) %>% summarize(sum=n())
ndGLM_ %>% filter(obs_int>5 & species=="CONI") %>% group_by(field_fate) %>% summarize(sum=n())
```


```{r}
ndGLM_ %>% filter(obs_int>5 & species=="LETE") %>% group_by(nest_age) %>% summarize(sum=n())
ndGLM_ %>% filter(obs_int>5 & species=="CONI") %>% group_by(nest_age) %>% summarize(sum=n())
# ndGLM_ %>% filter(species=="CONI") %>% group_by(nest_age) %>% summarize(sum=n())
```


```{r scale-df, eval=FALSE, include=FALSE}
table(ndGLM_scl$field_fate)
cat("camera fate of nests marked unknown in the field:\n")
uToFate <- ndGLM_scl %>% 
  filter(field_fate=="U") %>% 
  group_by(cam_fate) %>% 
  summarize(unknown = n())
gt(uToFate)

cat("true cause of failure for failed (unknown) nests:\n")
failToFate <- ndGLM_scl %>% filter(field_fate == "F") %>% 
  group_by(cam_fate) %>% 
  summarize(failed=n())
gt(failToFate)

trueFate <- left_join(uToFate, failToFate, by="cam_fate")
gt(trueFate)

cat("marked failed (known cause) but reclassified:\n")
failToFail <- ndGLM_scl %>% 
  filter(field_fate %in% c("A", "D", "Hu", "S", "Ca") & misclass==1) %>% 
  select(nest, species, field_fate, cam_fate) 

cat("marked hatched but reclassified as failed:\n") # only field fate was consolidated to 6 categories
hatchToFail <- ndGLM_scl %>% 
  filter(field_fate == "H" & HF_mis==1) %>% 
  select(nest, species, field_fate, cam_fate)

cat("marked failed but reclassified as hatched:\n")
failToHatch <- ndGLM_scl %>% 
  filter(field_fate %in% c("A", "D", "Hu", "S", "F", "Ca") & HF_mis==1) %>% 
  select(nest, species, field_fate, cam_fate)

# reassigned <- rbind(uToFate, failToFate,failToFail, failToHatch, hatchToFail)
reassigned <- rbind(failToFail, failToHatch, hatchToFail)
gt(reassigned)
# newFate <- rbind(uToFate, failToFate)
# gt(newFate)
# 

# fate_tab <- xtabs(~cam_fate+field_fate, data=ndGLM_scl)
# fate_tab
# fate_tab <- ftable(xtabs(~cam_fate+field_fate, data=ndGLM_scl))
# str(fate_tab) # matrix with two attributes with col names and row names
# ftab <- as.table(fate_tab)
# ftab
# fdf <- as.data.frame(ftab)
# fdf
# fate_tab <- summarytools::ctable(ndGLM_scl$cam_fate, ndGLM_scl$field_fate, prop="n")
# fate_tab[[1]]
# gt(fate_tab[[1]])
# ftab <- as.data.frame(fate_tab) # when you make it a df, it just "lengthens" it
# ftabg <- gt(ftab, rowname_col = "cam_fate", groupname_col = "field_fate", row_group_as_column = TRUE)
# ftabg
ndGLM_red <- readRDS("ndGLM_red.rds")
gtsummary::tbl_cross(ndGLM_red, row=field_fate, col=cam_fate)
gtsummary::tbl_cross(ndGLM_red, row=field_fate, col=cam_fate) %>%
  as_gt() %>%
  gtsave("fate_table.rtf") # doesn't want to save
# could use python to convert to rtf...
```

### Create histograms and correlation plots (optional)

```{r plot-parameters, eval=FALSE, include=FALSE}

if(corrplots1 | hist1 | corrplots2 | hist2){
  cat("max values:\n")
  sapply(predictors, function(x) max(dat[[x]], na.rm=TRUE))
  cat("\nand suggested bin width:\n") # freedman diaconis rule for bin width
  sapply(predictors, function(x) 2*((IQR(dat[[x]], na.rm=T)) / (length(dat[[x]])^(1/3))) )
} else {
  cat("\t\t>> skip")
}
```

#### question 1

```{r is_u-hist-1, eval=FALSE, include=FALSE}

  # dat <- dat %>%
  #   # mutate(across(c(nest_age, fdate, obs_int), as.integer)) %>%
  #   dplyr::mutate(fillVal = !(.data[[resp]]==0)) # switch the values so 0=TRUE

if(hist1 | hist2){
  catPlotU <- plot_predictors(resp="is_u",
                       dat=dat,
                       # vars = c("nest_age", "obs_int", "fdate"),
                       vars      = predictors,
                       filTit    = "Nest Fate",
                       filLabs   = c("Classifiable\nin Field", 
                                     "Not Classifiable\nin Field"), 
                       # filColors = c("#88CCEE", "#AA4499"),
                       filColors = c("#88CCEE", "#882255"),
                       # brVect    = list(var1 = list(),
                       brVect    = list(var1 = list(0,5,10,15,20,25,30),
                                        var2 = list(0,2,4,6,8,10),
                                        var3 = list(20,40,60,80,100,120)),
                       # filColors = c("green", "#AA4499"),
                       xLabs     = prLabs,
                       yLab      = "Count",
                       # xMaxVect = c(32, 10, 120),
                       xMaxVect = c(32, 10, 120),
                       binWidthVect = c(3, 1, 12),
                       suffix=paste0(datName, uVar)
                       )#,
  knitr::include_graphics(paste0(homeDir,"glm_script/",catPlotU), 
                          dpi=(1300/6)) # dpi setting = only thing that works
} else {
  cat("\t\t>> skip")
}
```

#### question 2


```{r HF_mis-plot-1, eval=FALSE, include=FALSE}
# badNest <- ndGLM1$nest[ndGLM1$obs_int>12]
if(hist1 | hist2){
  catPlotM <- plot_predictors(resp="HF_mis",
                       dat=dat,
                       vars = predictors,
                       filTit    = "Nest Fate",
                       filLabs   = c("Correctly\nClassified",
                                     "Incorrectly\nClassified"
                                     ),
                       # filLabs   = c("Classifiable\nin Field", 
                                     # "Not Classifiable\nin Field"), 
                       # filColors = c("#44AA99", "#EE7733"),
                       # filColors = c("#CCBB44", "#882255"),
                       # filColors = c("#999933", "#117733"),
                       filColors = c("#DDCC77", "#CC6677"),
                       xLabs     = prLabs,
                       yLab      = "Count",
                       # xMaxVect = c(32, 10, 120),
                       xMaxVect = c(32, 10, 120),
                       brVect    = list(var1 = list(0,5,10,15,20,25,30),
                                        var2 = list(0,2,4,6,8,10),
                                        var3 = list(20,40,60,80,100,120)),
                       # xMaxVect = c(32, 8, 120),
                       binWidthVect = c(3, 1, 12),
                       suffix=paste0(datName, uVar)
                       )#,
  knitr::include_graphics(paste0(homeDir,"glm_script/",catPlotM), 
                          dpi=(1300/6)) # dpi setting = only thing that works
} else {
  cat("\t\t>> skip")
}

```


#### species



```{r}
catPlotSp <- plot_predictors(resp="species",
                             dat=dat,
                             vars = predictors,
                             filTit    = "Species",
                             filLabs   = c("Common\nNighthawk",
                                           "Least\nTern"
                                           ),
                             filColors = c("#44AA99", "#AA4499"),
                             xLabs     = prLabs,
                             yLab      = "Count",
                             # xMaxVect = c(32, 10, 120),
                             xMaxVect = c(32, 10, 120),
                             brVect    = list(var1 = list(0,5,10,15,20,25,30),
                                              var2 = list(0,2,4,6,8,10),
                                              var3 = list(20,40,60,80,100,120)),
                             binWidthVect = c(3, 1, 12),
                             suffix=paste0(datName, uVar)
                             )#,
```

#### true fate

```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
names(cbPalette) <- unique(ndGLM_$cam_fate)
catPlotSp <- plot_predictors(resp="cam_fate",
                             dat=dat,
                             vars = predictors,
                             filTit    = "Species",
                             # filLabs   = unique(ndGLM_$cam_fate),
                             # filLabs   = names(cbPalette),
                             filColors = cbPalette,
                             xLabs     = prLabs,
                             yLab      = "Count",
                             # xMaxVect = c(32, 10, 120),
                             xMaxVect = c(32, 10, 120),
                             brVect    = list(var1 = list(0,5,10,15,20,25,30),
                                              var2 = list(0,2,4,6,8,10),
                                              var3 = list(20,40,60,80,100,120)),
                             binWidthVect = c(3, 1, 12),
                             suffix=paste0(datName, uVar)
                             )#,
```

#### correlation

```{r scatterplot}
# names(pairList)
# pairList <- combn(predictors, m=2, simplify=F)
# spc <- 
if(corrplots1 | corrplots2){
  pairList <- combn(prList, m=2, simplify=FALSE)
  plList <- lapply(pairList, function(x){
    # ggplot(data=dat, aes(x=get(x[1]), y=get(x[2])) ) +
    ggplot(data=dat, aes(x=get(x[[1]]), y=get(x[[2]])) ) +
      geom_point() +
      geom_smooth(method=lm) +
      # ggpmisc::stat_poly_eq() +
      xlab(names(x)[1]) +
      ylab(names(x)[2]) +
      # ggtitle("Correlation Plots - NA removed")+
      # ggpubr::stat_cor( geom="label", label.x.npc = "middle", label.y.npc = "top") #+
      ggpubr::stat_cor( geom="label", label.y.npc = "top", size=8, face="bold") +
      theme_classic() +
      theme(axis.text = element_text(size=18),
          axis.title = element_text(size=20), # can't do margins for x and y axis titles at once
          axis.title.y = element_text(margin=margin(r=5)),
          axis.title.x = element_text(margin=margin(t=5))) +
          # plot.margin=margin(c(0.3,1,0.3,0.1), "cm")
      # theme( plot.margin=unit(c(1,0.5,1,0.5), "cm") ) # margins for 3-column arrangment
      theme( plot.margin=unit(c(0.5,1,0.5,1), "cm") ) # margins for 3-row arrangement
      # theme(panel.background = element_rect(fill="lightgray", alpha=0.5))
    })
  # dsgn <- "AB
  #          C#"
  # pl <- patchwork::wrap_plots(plList)
  pl <- patchwork::wrap_plots(plList,
                              ncol=2,
                              nrow=2)
                              # design=dsgn)
  # add plot margin after assembly?
  # pl <- pl + theme( plot.margin=margin(c(1,1,1,0), "cm"))
  # ggsave(filename=paste0("corrPlot", now, ".svg"))
  pl
  
  now = format(Sys.time(), "_%m%d_%H%M_")
  
  fname <- paste0(homeDir, "glm_script/figures/corr_plot_cc_", now, ".svg")
  # ggsave(fname, plot=pl, width=9, height=3)
  ggsave(fname, plot=pl, width=10, height=10)
  knitr::include_graphics(fname, 
                          dpi=(1300/6)) # dpi setting = only thing that works
} else {
  cat("\t\t>> skip")
}
```

```{r correlation-plots-2, eval=FALSE, include=FALSE}
library("PerformanceAnalytics")
cormat <- dat |> 
  select(nest_age, obs_int, fdate) |>
  data.matrix() |>
  chart.Correlation(histogram=T)
```